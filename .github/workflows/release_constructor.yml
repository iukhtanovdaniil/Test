name: Build Release Installers

on:
  release:
    types:
      - published
  workflow_dispatch:
    inputs:
      version:
        description: "Version to package (e.g. 0.0.4). Defaults to release tag when empty."
        required: false

# This enables to run a single workflow at a time
concurrency:
  group: notebooks-global-lock-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  bump-version:
    name: Bump version on main branch
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Determine release version
        id: version
        run: |
          set -euxo pipefail
          RAW="${{ github.event.release.tag_name }}"
          RAW="${RAW#v}"
          echo "release_version=$RAW" >> "$GITHUB_OUTPUT"
          echo "RELEASE_VERSION=$RAW" >> "$GITHUB_ENV"

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install requirements
        run: pip install -r .tools/requirements.txt

      - name: Sync versioned files
        run: |
          bash .tools/bash/run_with_context.sh \
            artifacts/bump_version_main.log \
            "bump_version.py" \
            .tools/python/bump_version.py \
            python .tools/python/bump_version.py "${RELEASE_VERSION}"
          bash .tools/bash/run_with_context.sh \
            artifacts/bump_constructor_main.log \
            "bump_constructor.py" \
            .tools/python/bump_constructor.py \
            python .tools/python/bump_constructor.py
          bash .tools/bash/run_with_context.sh \
            artifacts/bump_Welcome_notebook_main.log \
            "bump_Welcome_notebook.py" \
            .tools/python/bump_Welcome_notebook.py \
            python .tools/python/bump_Welcome_notebook.py "${{ github.repository_owner }}" "${{ github.event.repository.name }}"


      - name: Commit updated versioned files
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          branch: main
          commit_message: GitHub Action - Update version to "${RELEASE_VERSION}"

      - name: Upload diagnostics
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: release-bump-version-logs
          path: artifacts/*.log
          if-no-files-found: ignore

  build-installers:
    name: Build installers (${{ matrix.os_name }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os_name: linux
            runner: ubuntu-latest
          - os_name: macos-arm64
            runner: macos-15
          - os_name: macos-intel
            runner: macos-15-intel
          - os_name: windows
            runner: windows-latest
    defaults:
      run:
        shell: bash -l {0}
    env:
      CONSTRUCTOR_ENV: constructor-env
      OUTPUT_DIR: dist/${{ matrix.os_name }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Determine release version
        id: version
        run: |
          set -euxo pipefail
          if [ "${{ github.event_name }}" = "release" ]; then
            RAW="${{ github.event.release.tag_name }}"
          else
            RAW="${{ inputs.version }}"
          fi

          if [ -z "$RAW" ]; then
            echo "Version is required when running manually." >&2
            exit 1
          fi

          RAW="${RAW#v}"
          echo "release_version=$RAW" >> "$GITHUB_OUTPUT"
          echo "RELEASE_VERSION=$RAW" >> "$GITHUB_ENV"

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install requirements
        run: pip install -r .tools/requirements.txt
        
      - name: Sync versioned files and populate Welcome notebook
        run: |
          bash .tools/bash/run_with_context.sh \
            "artifacts/${{ matrix.os_name }}-bump_version.log" \
            "bump_version.py" \
            .tools/python/bump_version.py \
            python .tools/python/bump_version.py "${RELEASE_VERSION}"
          bash .tools/bash/run_with_context.sh \
            "artifacts/${{ matrix.os_name }}-bump_constructor.log" \
            "bump_constructor.py" \
            .tools/python/bump_constructor.py \
            python .tools/python/bump_constructor.py
          bash .tools/bash/run_with_context.sh \
            "artifacts/${{ matrix.os_name }}-bump_Welcome_notebook.log" \
            "bump_Welcome_notebook.py" \
            .tools/python/bump_Welcome_notebook.py \
            python .tools/python/bump_Welcome_notebook.py "${{ github.repository_owner }}" "${{ github.event.repository.name }}"

      - name: Set up Miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-activate-base: true
          miniforge-version: latest
          installer-type: Miniforge3
          use-mamba: true

      - name: Create constructor environment
        run: |
          set -euxo pipefail
          conda create -y -n "${CONSTRUCTOR_ENV}" -c conda-forge -c defaults python=3.11 constructor

      - name: Build installer with constructor
        run: |
          set -euxo pipefail
          mkdir -p "${OUTPUT_DIR}"
          conda run -n "${CONSTRUCTOR_ENV}" constructor . --output-dir "${OUTPUT_DIR}"

      - name: Upload diagnostics
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-installers-${{ matrix.os_name }}-logs
          path: artifacts/*.log
          if-no-files-found: ignore
      - name: Upload installers to release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/${{ matrix.os_name }}/*
          fail_on_unmatched_files: true
